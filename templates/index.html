<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Propriedades</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body, html {
            height: 100%;
            margin: 0;
        }
        #map-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .leaflet-control-custom {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
        }
        .leaflet-control-custom:hover {
            background: #f4f4f4;
        }
        .icon-button {
            width: 24px;
            height: 24px;
            background: url('https://cdn-icons-png.flaticon.com/512/992/992651.png') no-repeat center center;
            background-size: contain;
        }
        #markerForm {
            display: none;
            position: absolute;
            top: 50px;
            right: 50px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="map-container">
        {{ map_html|safe }}
    </div>

    <!-- Formulário para adicionar marcador -->
    <div id="markerForm">
        <form id="form">
            Latitude: <input type="text" id="lat" name="lat" required><br>
            Longitude: <input type="text" id="lon" name="lon" required><br>
            <button type="submit">Adicionar</button>
            <button type="button" id="closeFormButton">Cancelar</button>
        </form>
    </div>

    <script>
        $(document).ready(function() {
            function initializeMap() {
                var map = L.map('map').setView([-19.7448, -47.9388], 10);
                console.log('Map initialized');

                var openStreetMapLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                var esriWorldImageryLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{x}/{y}', {
                    attribution: 'Tiles &copy; Esri'
                });

                var userMarkersLayer = L.layerGroup().addTo(map);

                // Carregar os dados GeoJSON
                $.getJSON('/limite_apa', function(data) {
                    L.geoJson(data).addTo(map);
                });

                $.getJSON('/area_do_pasto', function(data) {
                    L.geoJson(data, {
                        style: { color: 'green', fillColor: 'green' }
                    }).addTo(map);
                });

                $.getJSON('/skimmed_properties', function(data) {
                    L.geoJson(data, {
                        style: { color: 'gray', fillColor: 'gray' }
                    }).addTo(map);
                });

                // Controle personalizado para adicionar marcador
                var customControl = L.Control.extend({
                    options: {
                        position: 'topright'
                    },
                    onAdd: function (map) {
                        var container = L.DomUtil.create('div', 'leaflet-control-custom leaflet-bar');

                        console.log('Custom control added');

                        var button = L.DomUtil.create('div', 'icon-button', container);
                        L.DomEvent.on(container, 'click', function () {
                            console.log('Button clicked');
                            $('#markerForm').toggle();
                        });
                        return container;
                    }
                });

                map.addControl(new customControl());

                $('#form').on('submit', function(event) {
                    event.preventDefault();
                    var lat = $('#lat').val();
                    var lon = $('#lon').val();
                    $.post('/add_marker', { lat: lat, lon: lon }, function(data) {
                        if (data.status === "success") {
                            var marker = L.marker([data.lat, data.lon]).addTo(userMarkersLayer)
                                .bindPopup("User added marker at (" + data.lat + ", " + data.lon + ")");
                            $('#markerForm').hide();
                        } else {
                            alert(data.message);
                        }
                    });
                });

                $('#closeFormButton').on('click', function() {
                    $('#markerForm').hide();
                });

                $('#removeMarkers').on('click', function() {
                    $.post('/remove_markers', function(data) {
                        if (data.status === "success") {
                            userMarkersLayer.clearLayers();
                        }
                    });
                });

                var baseLayers = {
                    "OpenStreetMap": openStreetMapLayer,
                    "Esri WorldImagery": esriWorldImageryLayer
                };

                var overlayLayers = {
                    "Limites APA": limites_group,
                    "Área de Pasto": area_pasto_group,
                    "CAR": car_group,
                    "Centroides": marcadores_group,
                    "User Markers": userMarkersLayer
                };

                L.control.layers(baseLayers, overlayLayers).addTo(map);
            }

            setTimeout(initializeMap, 500);  // Adiciona um pequeno atraso para garantir que o mapa esteja disponível no DOM
        });
    </script>
</body>
</html>
